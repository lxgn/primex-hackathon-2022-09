# primex-hackathon-2022-09
Update for https://github.com/primex-finance/ETHWarsaw_2022

## Первая версия контракта: создание массива, тестовые транзакции, анализ

Берем оригинал контракта. Делаем легкие правки для onchain/offchain анализа.

Вот контракт
0xce36a4D2208Cf4Dd7fE32baA29cC7DA9b7137a69
транзакция создания
https://mumbai.polygonscan.com/tx/0x1f73b4ae87e6a8e6e14932192229f54d5c05e886811b35ec28f88f1e7d179d64
добавил логов, их всего 505
По нему видно у кого какой isClosable

Создался массив из 100 значений

Делаю выборку с 0 курсором 50 значений.
Вывод ограничивается _sizeLimit
Выбрал 10 значений

Попробовал closeElements меньше чем 10 значений, транзакция зафейлилась

сделал closeElements
4,6,7,9,12,15,16,17,19,22

транзакция здесь
https://mumbai.polygonscan.com/tx/0x8e293f13ed32a836b9865491caa9d48d6bc8c39144b80066ad65d193015c9454
Удалило эти 10
с 90 начало в обратном порядке добавлять, на места удаленных
При этом elementsId стало вместо 100 - 102
хотя вроде как не должно добавить
  id   uint256 :  99
  isClosable   bool :  false
Это типа как ошибка в контракте?
и elementLength стала 92

Не совсем понял как правильно курсор выставлять, его по идее можно тянуть и до 70-80, чтобы получить 10 элементов


Снова делаю getClosableElements
от _cursor 0 и _count 100
выдает  1,98,97,96,18,91,20,90,23,24

Кормлю в closeElements
https://mumbai.polygonscan.com/tx/0x2be5eea8ad35a37d59b6b55a7bf8f6f8f7b45dd36e3a0d33d8d09c6ac54877f4
elementsId 124 
elementLength 104
Видимо не ошибка

getClosableElements
теперь делаю
1,2,3,4,5,6,7,8,9,10
https://mumbai.polygonscan.com/tx/0x2616adbe9372294edcc7186499610b375972d3a1cf071814482aa37a3cdd3699
транзакция прошла
elementsId 125 
elementLength 104

## Вторая версия контракта: сокращение операции для кипера, перенос в контракт. Добавление просто защиты от лавинообразных транзакций

Меняем в closeElements входящие переменные с массива на курсор. Или нет, без параметров делаем и создаем cursorGlobal.
97% всех вычислений в блокчейне можно делать onChain. Поэтому мы убираем просчеты с кипера, защищая тем самым себя от недобросовестной работы кипера.


Делаем деплой
https://mumbai.polygonscan.com/address/0x29E83F173D29A2cdD61B9367B0739eF026082581#code

Массив из 100 элементов создан.
Он во вкладке логов в polygonscan.com 
https://mumbai.polygonscan.com/tx/0x07fc2323f464637cc1093dac26f64598118c4da768ee2a5f4650787987ebc09d#eventlog
и 
в файле https://github.com/lxgn/primex-hackathon-2022-09/blob/main/contracts/ElementManager_v02.deploy.isClosable.txt

Также в контракте появилась функция needProcess()
Результат которой показывает необходимость дергать кипером функцию.
А если даже он ее дернет, то газа потратиться максимально мало, т.к. функция выйдет сразу.

В текущем варианте заложено, что киперам достаточно выполнять процессинг не чаще 1 раза в 30 секунд с целью не делать 10 одниковых сбросов в Closable и не делать_shakeElements, а значит экономить газззз.

### Наглядный пример:
Две подряд транзакции

Газ: 0.002740026031
https://mumbai.polygonscan.com/tx/0xe46d0672e6aa0d978cced819590976ae78c95d887e190ba35d5524514df2d546

Газ: 0.0000500085
https://mumbai.polygonscan.com/tx/0x59b9f0076ff19ca960559f6b86e4cc3878c6579e5f7cc0a5d3e2155f26d9dea2
Здесь открываем лог:
https://mumbai.polygonscan.com/tx/0x59b9f0076ff19ca960559f6b86e4cc3878c6579e5f7cc0a5d3e2155f26d9dea2#eventlog
и видим: Exit by needProces false


Cursor global изменился на 10.
Делаю еще транзакции
https://mumbai.polygonscan.com/tx/0x4028ecbef7197c249f8d5dd50d2bef5787ba15846db325356fab2ed15106b332#eventlog

# ВЫВОД
- процессинг контракта защищен от дубликатов вычислений в одном блоке
- добавлена настраиваемая переменная по времени для необходимости процессинга контракта 
- в случае если даже была отправлена транзакция - то она займет минимум газа
- сделана функция чтения, вызвав которую кипер может понять - нужно ли ему отправлять транзакцию.
- для кипера убраны любые вычисления, чтобы оградить контракт от недобросовестных вычислений, или банальных ошибок
- добавлена общая переменная курсора, которая общая для всего контракта и для всех киперов
- контракт задеплоен, протестирован и выложен на гитхаб.
- в таком варианте нет большой необходимости в поддержании сложных киперов. Минимальная катастрофоустойчивая конфигурация - дешевые впс минимум в 3 разных странах.
 